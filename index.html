<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é•¿å›¾ç¼–è¾‘å·¥å…·</title>
    <link rel="stylesheet" href="styles.css">
    <!-- å¼•å…¥Fabric.jsåº“ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <!-- åº“åŠ è½½æ£€æŸ¥ -->
    <script>
        window.addEventListener('load', function() {
            if (typeof fabric === 'undefined') {
                console.error('Fabric.js åº“åŠ è½½å¤±è´¥ï¼');
                alert('å›¾åƒç¼–è¾‘åº“åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•ã€‚');
            } else {
                console.log('Fabric.js åº“åŠ è½½æˆåŠŸï¼Œç‰ˆæœ¬ï¼š' + fabric.version);
            }
        });
    </script>
</head>
<body>
    <!-- å…¨å±€æ‹–æ”¾äº‹ä»¶å¤„ç† -->
    <script>
        // é˜»æ­¢æµè§ˆå™¨é»˜è®¤çš„æ‹–æ”¾è¡Œä¸º
        document.addEventListener('dragover', function(e) {
            e.preventDefault();
            e.stopPropagation();
        }, false);
        
        document.addEventListener('drop', function(e) {
            e.preventDefault();
            e.stopPropagation();
        }, false);
    </script>
    <div class="container">
        <header>
            <h1>é•¿å›¾ç¼–è¾‘å·¥å…·pro</h1>
            <div class="tool-bar">
                <div class="tool-group">
                    <button id="rectangle-tool" class="tool-btn" title="çº¢æ¡†æ ‡æ³¨">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                        </svg>
                    </button>
                    <button id="mosaic-tool" class="tool-btn" title="é©¬èµ›å…‹">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M4 4h4v4H4V4z"></path>
                            <path d="M10 4h4v4h-4V4z"></path>
                            <path d="M16 4h4v4h-4V4z"></path>
                            <path d="M4 10h4v4H4v-4z"></path>
                            <path d="M10 10h4v4h-4v-4z"></path>
                            <path d="M16 10h4v4h-4v-4z"></path>
                            <path d="M4 16h4v4H4v-4z"></path>
                            <path d="M10 16h4v4h-4v-4z"></path>
                            <path d="M16 16h4v4h-4v-4z"></path>
                        </svg>
                    </button>
                    <button id="text-tool" class="tool-btn" title="æ·»åŠ æ–‡å­—">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="4 7 4 4 20 4 20 7"></polyline>
                            <line x1="9" y1="20" x2="15" y2="20"></line>
                            <line x1="12" y1="4" x2="12" y2="20"></line>
                        </svg>
                    </button>
                </div>
                <div class="control-group">
                    <button id="undo-btn" class="tool-btn" title="æ’¤é”€">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M9 14L4 9l5-5"></path>
                            <path d="M4 9h11c4 0 7 3 7 7v0c0 4-3 7-7 7H8"></path>
                        </svg>
                    </button>
                    <button id="zoom-in" class="tool-btn" title="æ”¾å¤§">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="11" cy="11" r="8"></circle>
                            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                            <line x1="11" y1="8" x2="11" y2="14"></line>
                            <line x1="8" y1="11" x2="14" y2="11"></line>
                        </svg>
                    </button>
                    <button id="zoom-out" class="tool-btn" title="ç¼©å°">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="11" cy="11" r="8"></circle>
                            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                            <line x1="8" y1="11" x2="14" y2="11"></line>
                        </svg>
                    </button>
                    <button id="download-btn" class="action-btn" title="ä¸‹è½½å›¾ç‰‡">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="7 10 12 15 17 10"></polyline>
                            <line x1="12" y1="15" x2="12" y2="3"></line>
                        </svg>
                        ä¸‹è½½
                    </button>
                    <button id="back-btn" class="action-btn" title="è¿”å›ä¸Šä¼ ">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M19 12H5"></path>
                            <polyline points="12 19 5 12 12 5"></polyline>
                        </svg>
                        è¿”å›
                    </button>
                </div>
            </div>
        </header>
        
        <main>
            <div id="drop-zone" class="upload-area">
                <p>å°†å›¾ç‰‡æ‹–æ”¾åˆ°æ­¤å¤„ï¼Œæˆ–ç‚¹å‡»ä¸Šä¼ </p>
                <input type="file" id="file-input" accept="image/*" hidden>
                <div id="loading-indicator" class="loading-indicator" style="display: none;">
                    <div class="spinner"></div>
                    <p>æ­£åœ¨åŠ è½½å›¾ç‰‡...</p>
                </div>
                <div id="error-message" class="error-message" style="display: none;"></div>
            </div>

            <div id="canvas-container" class="canvas-container" style="display: none;">
                <canvas id="editor-canvas"></canvas>
            </div>
            
            <div id="tips" class="tips">
                <h3>æ“ä½œæç¤º</h3>
                <ul>
                    <li><span class="tip-icon">ğŸ–Šï¸</span> çº¢æ¡†æ ‡æ³¨ï¼šç‚¹å‡»çº¢æ¡†å·¥å…·ï¼Œç„¶ååœ¨å›¾ç‰‡ä¸Šæ‹–åŠ¨ç»˜åˆ¶çŸ©å½¢</li>
                    <li><span class="tip-icon">ğŸ§©</span> é©¬èµ›å…‹ï¼šç‚¹å‡»é©¬èµ›å…‹å·¥å…·ï¼Œåœ¨éœ€è¦éšè—çš„åŒºåŸŸæ¶‚æŠ¹</li>
                    <li><span class="tip-icon">ğŸ“</span> æ–‡å­—ç¼–è¾‘ï¼šç‚¹å‡»æ–‡å­—å·¥å…·ï¼Œç„¶åç‚¹å‡»å›¾ç‰‡ä¸Šçš„ä½ç½®æ·»åŠ æ–‡å­—</li>
                    <li><span class="tip-icon">ğŸ”</span> ç¼©æ”¾è§†å›¾ï¼šç‚¹å‡»æ”¾å¤§/ç¼©å°æŒ‰é’®ï¼Œæˆ–æŒ‰ä½Alté”®æ‹–åŠ¨ç”»å¸ƒ</li>
                    <li><span class="tip-icon">â†©ï¸</span> æ’¤é”€æ“ä½œï¼šç‚¹å‡»æ’¤é”€æŒ‰é’®å¯æ’¤é”€æœ€åä¸€æ­¥æ“ä½œ</li>
                    <li><span class="tip-icon">ğŸ’¾</span> ä¸‹è½½å›¾ç‰‡ï¼šç‚¹å‡»ä¸‹è½½æŒ‰é’®ä¿å­˜ç¼–è¾‘åçš„å›¾ç‰‡</li>
                </ul>
            </div>
        </main>
    </div>

    <script src="fix-zoom.js"></script>
    <!-- æ€§èƒ½ä¼˜åŒ–è„šæœ¬ - éœ€è¦åœ¨å…¶ä»–è„šæœ¬ä¹‹å‰åŠ è½½ -->
    <script src="optimize-performance.js"></script>
    <script src="fix-tools.js"></script>
    <!-- çŸ©å½¢å·¥å…·æ€§èƒ½ä¼˜åŒ– -->
    <script src="fix-rectangle.js"></script>
    <!-- å·¥å…·è®¾ç½®é¢æ¿åˆå§‹åŒ–ä¿®å¤ -->
    <script src="fix-panel.js"></script>
    <!-- åæ ‡è®¡ç®—ä¿®å¤è„šæœ¬ -->
    <script src="fix-coordinate.js"></script>
    <script src="app.js"></script>
    
    <!-- è¾…åŠ©è„šæœ¬ï¼Œç¡®ä¿å›¾ç‰‡æ­£ç¡®æ˜¾ç¤º -->
    <script>
        // è‹¥åˆå§‹åŠ è½½å5ç§’å›¾åƒä»æœªæ˜¾ç¤ºï¼Œå°è¯•ä½¿ç”¨å¤‡ç”¨æ–¹æ³•
        window.setTimeout(function() {
            const displayedImage = document.getElementById('displayed-image');
            if (!displayedImage) {
                console.log('æœªæ£€æµ‹åˆ°æ˜¾ç¤ºçš„å›¾ç‰‡ï¼Œå°è¯•ä¿®å¤...');
                
                // æ£€æŸ¥æ˜¯å¦æœ‰å›¾ç‰‡æ•°æ®ä½†æœªæ˜¾ç¤º
                const canvasContainer = document.getElementById('canvas-container');
                if (canvasContainer && canvasContainer.style.display === 'block' && canvasContainer.innerHTML === '') {
                    console.log('Canvaså®¹å™¨å¯è§ä½†ä¸ºç©ºï¼Œå°è¯•é‡æ–°åŠ è½½');
                    // å°è¯•è¿”å›ä¸Šä¼ é¡µé¢
                    if (typeof backToUpload === 'function') {
                        backToUpload();
                        if (typeof showError === 'function') {
                            showError('å›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œè¯·é‡æ–°ä¸Šä¼ ');
                        }
                    }
                }
            }
        }, 5000);
        
        // åŒå‡»é¡µé¢ä»»æ„ä½ç½®å¼ºåˆ¶æ˜¾ç¤ºå›¾ç‰‡
        document.addEventListener('dblclick', function() {
            const canvasContainer = document.getElementById('canvas-container');
            if (canvasContainer) {
                console.log('ç”¨æˆ·åŒå‡»ï¼Œå¼ºåˆ¶æ˜¾ç¤ºå®¹å™¨');
                canvasContainer.style.display = 'block';
                canvasContainer.classList.add('image-view-mode');
            }
        });
        
        // ç¡®ä¿æ–‡ä»¶è¾“å…¥å˜åŒ–æ—¶å¤„ç†ä¸Šä¼ 
        document.addEventListener('DOMContentLoaded', function() {
            const fileInput = document.getElementById('file-input');
            const dropZone = document.getElementById('drop-zone');
            
            if (fileInput && dropZone) {
                dropZone.addEventListener('click', function() {
                    fileInput.click();
                });
                
                fileInput.addEventListener('change', function(e) {
                    if (this.files && this.files.length > 0) {
                        const file = this.files[0];
                        
                        // æ£€æŸ¥æ˜¯å¦ä¸ºå›¾ç‰‡
                        if (file.type.match('image.*')) {
                            // éšè—ä¸Šä¼ åŒºåŸŸï¼Œæ˜¾ç¤ºåŠ è½½æŒ‡ç¤ºå™¨
                            dropZone.style.display = 'none';
                            const loadingIndicator = document.getElementById('loading-indicator');
                            if (loadingIndicator) {
                                loadingIndicator.style.display = 'flex';
                            }
                            
                            // ä½¿ç”¨å…¨å±€å‡½æ•°å¤„ç†æ–‡ä»¶
                            if (typeof loadImageFromFile === 'function') {
                                loadImageFromFile(file);
                            } else if (typeof FileReader !== 'undefined') {
                                // å¤‡ç”¨æ–¹æ³• - ç¡®ä¿åˆ›å»ºdrawing-overlay
                                const reader = new FileReader();
                                reader.onload = function(e) {
                                    const imageUrl = e.target.result;
                                    // è·å–å®¹å™¨
                                    const canvasContainer = document.getElementById('canvas-container');
                                    if (canvasContainer) {
                                        // æ˜¾ç¤ºå›¾ç‰‡
                                        canvasContainer.style.display = 'flex';
                                        canvasContainer.innerHTML = '<div id="image-container" style="position: relative; width: 100%;"><img id="displayed-image" src="' + imageUrl + '" style="max-width: 100%; height: auto;" draggable="false"></div>';
                                        
                                        // åˆ›å»ºç»˜å›¾è¦†ç›–å±‚ - è¿™æ˜¯å…³é”®
                                        const imageContainer = document.getElementById('image-container');
                                        const displayedImage = document.getElementById('displayed-image');
                                        
                                        if (imageContainer && displayedImage) {
                                            // ç­‰å¾…å›¾ç‰‡åŠ è½½
                                            displayedImage.onload = function() {
                                                console.log('å¤‡ç”¨æ–¹æ³•: å›¾ç‰‡åŠ è½½å®Œæˆ');
                                                
                                                // åˆ›å»ºç»˜å›¾è¦†ç›–å±‚
                                                const overlay = document.createElement('div');
                                                overlay.className = 'drawing-overlay';
                                                overlay.style.position = 'absolute';
                                                overlay.style.top = '0';
                                                overlay.style.left = '0';
                                                overlay.style.width = '100%';
                                                overlay.style.height = '100%';
                                                overlay.style.pointerEvents = 'auto'; // ç¡®ä¿å¯ä»¥æ¥æ”¶äº‹ä»¶
                                                overlay.style.zIndex = '10'; // ç¡®ä¿åœ¨å›¾ç‰‡ä¸Šå±‚
                                                imageContainer.appendChild(overlay);
                                                
                                                console.log('å¤‡ç”¨æ–¹æ³•: ç»˜å›¾è¦†ç›–å±‚åˆ›å»ºå®Œæˆ');
                                            };
                                        }
                                    }
                                    // éšè—åŠ è½½æŒ‡ç¤ºå™¨
                                    if (loadingIndicator) {
                                        loadingIndicator.style.display = 'none';
                                    }
                                };
                                reader.readAsDataURL(file);
                            }
                        } else {
                            // æ˜¾ç¤ºé”™è¯¯
                            if (typeof showError === 'function') {
                                showError('è¯·ä¸Šä¼ å›¾ç‰‡æ–‡ä»¶');
                            } else {
                                alert('è¯·ä¸Šä¼ å›¾ç‰‡æ–‡ä»¶');
                            }
                        }
                    }
                });
            }
        });
    </script>

    <!-- ä¿®å¤ä¸‹è½½åŠŸèƒ½çš„è„šæœ¬ -->
    <!-- é©¬èµ›å…‹è™šåŒ–åŠŸèƒ½ä¿®å¤è„šæœ¬ -->
    <script src="fix-mosaic.js"></script>
    <script src="fix-download.js"></script>
</body>
</html> 